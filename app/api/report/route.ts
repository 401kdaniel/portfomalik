import { NextResponse } from "next/server"
import { generateText } from "ai"
import { openai } from "@ai-sdk/openai"

export async function POST(request: Request) {
  try {
    const { portfolioData } = await request.json()

    // Проверяем, что у нас есть ключ OpenAI API
    const OPENAI_API_KEY = process.env.OPENAI_API_KEY

    if (!OPENAI_API_KEY) {
      console.error("API ключ OpenAI не настроен")
      return NextResponse.json(
        {
          success: false,
          error: "API ключ OpenAI не настроен",
        },
        { status: 500 },
      )
    }

    // Формируем информацию о портфеле для промпта
    let portfolioInfo = `
    Профиль риска: ${portfolioData.risk_profile.charAt(0).toUpperCase() + portfolioData.risk_profile.slice(1)}
    Распределение активов:
    `

    for (const [asset, percentage] of Object.entries(portfolioData.allocation)) {
      portfolioInfo += `- ${asset.charAt(0).toUpperCase() + asset.slice(1)}: ${percentage}%\n`
    }

    portfolioInfo += "\nРекомендуемые компании:\n"

    for (const company of portfolioData.recommendations) {
      portfolioInfo +=
        `- ${company.name} (${company.symbol}): Сектор - ${company.sector}, ` +
        `Текущая цена - $${company.current_price}, Бета - ${company.beta}, ` +
        `Дивидендная доходность - ${company.dividend_yield.toFixed(2)}%, ` +
        `Изменение цены за 5 лет - ${company.price_change_5y.toFixed(2)}%\n`
    }

    if (portfolioData.correlation_matrix) {
      portfolioInfo += "\nМатрица корреляции между акциями:\n"

      for (let i = 0; i < portfolioData.correlation_matrix.length; i++) {
        portfolioInfo += portfolioData.correlation_matrix[i].join("\t") + "\n"
      }
    } else {
      portfolioInfo += "\nМатрица корреляции между акциями недоступна.\n"
    }

    // Создаем промпт для OpenAI
    const prompt = `
    На основе следующей информации о инвестиционном портфеле, предоставь детальный и профессиональный анализ и описание портфеля и включенных в него компаний. Отчет должен быть структурированным, включать следующие разделы:

    1. **Введение**
       - Краткое описание инвестиционного портфеля.
       - Цели и задачи инвестирования на основе профиля пользователя.

    2. **Обзор распределения активов**
       - Анализ распределения активов (акции, облигации, наличные).
       - Объяснение выбора распределения с учетом профиля риска.

    3. **Анализ рекомендуемых компаний**
       Для каждой компании предоставь:
       - **Название и символ**: Объясни, почему эта компания включена в портфель.
       - **Сектор**: Объяснение роли сектора в портфеле.
       - **Текущая цена**: Анализ текущей цены акции.
       - **Бета**: Объяснение показателя бета и его влияние на риск портфеля.
       - **Дивидендная доходность**: Анализ стабильности и привлекательности дивидендов.
       - **Изменение цены за 5 лет**: Историческая динамика цены акции и ее влияние на портфель.

    4. **Корреляция между акциями**
       - Представь матрицу корреляции между акциями.
       - Анализируй степень взаимосвязи между акциями и как это влияет на диверсификацию портфеля.

    5. **Риски и возможности**
       - Оценка рисков, связанных с текущим распределением активов и выбранными компаниями.
       - Потенциальные возможности для роста и диверсификации.

    6. **Заключение**
       - Итоговая оценка портфеля.
       - Рекомендации по возможным корректировкам или дальнейшим действиям.

    **Информация о портфеле:**
    ${portfolioInfo}

    Пожалуйста, напиши отчет на русском языке, который будет понятен и информативен для пользователя. Напиши его в стиле параграфов.
    `

    try {
      console.log("Отправка запроса к OpenAI API")
      // Вызываем OpenAI API
      const { text } = await generateText({
        model: openai("gpt-4o"),
        prompt: prompt,
        system: "Вы — финансовый консультант уровня PhD с глубоким пониманием рынков и инвестиционных стратегий.",
      })

      console.log("Отчет успешно сгенерирован")

      return NextResponse.json({
        success: true,
        report: text,
      })
    } catch (error) {
      console.error("Ошибка при вызове OpenAI API:", error)

      // Генерируем базовый отчет без OpenAI
      const riskProfile = portfolioData.risk_profile
      const basicReport = `
        # Анализ инвестиционного портфеля

        ## Введение
        
        Данный инвестиционный портфель разработан с учетом вашего ${
          riskProfile === "conservative"
            ? "консервативного"
            : riskProfile === "moderate"
              ? "умеренного"
              : "агрессивного"
        } профиля риска. Основная цель портфеля - ${
          riskProfile === "conservative"
            ? "сохранение капитала с минимальным риском"
            : riskProfile === "moderate"
              ? "обеспечение стабильного роста при умеренном риске"
              : "максимизация доходности при высоком риске"
        }.
        
        ## Обзор распределения активов
        
        Распределение активов в вашем портфеле:
        - Акции: ${portfolioData.allocation.stocks}%
        - Облигации: ${portfolioData.allocation.bonds}%
        - Наличные: ${portfolioData.allocation.cash}%
        
        Такое распределение активов соответствует вашему профилю риска и обеспечивает ${
          riskProfile === "conservative"
            ? "высокую степень защиты капитала"
            : riskProfile === "moderate"
              ? "баланс между ростом и защитой капитала"
              : "максимальные возможности для роста"
        }.
        
        ## Анализ рекомендуемых компаний
        
        ${portfolioData.recommendations
          .map(
            (company: any) => `
        ### ${company.name} (${company.symbol})
        
        Сектор: ${company.sector}
        Текущая цена: $${company.current_price.toFixed(2)}
        Бета: ${company.beta.toFixed(2)}
        Дивидендная доходность: ${company.dividend_yield.toFixed(2)}%
        Изменение цены за 5 лет: ${company.price_change_5y.toFixed(2)}%
        `,
          )
          .join("\n")}
        
        ## Корреляция между акциями
        
        Матрица корреляции показывает взаимосвязь между выбранными акциями, что помогает оценить диверсификацию портфеля.
        
        ## Риски и возможности
        
        ### Риски:
        ${
          riskProfile === "conservative"
            ? "- Инфляционный риск: консервативные портфели могут не обеспечивать достаточную защиту от инфляции\n- Риск упущенной выгоды: при росте рынка ваш портфель может показывать более скромные результаты"
            : riskProfile === "moderate"
              ? "- Рыночный риск: умеренный портфель подвержен колебаниям рынка\n- Секторный риск: значительная доля технологических компаний может привести к волатильности при проблемах в этом секторе"
              : "- Высокий рыночный риск: агрессивный портфель сильно подвержен колебаниям рынка\n- Риск концентрации: высокая доля технологических и инновационных компаний может привести к значительным потерям при проблемах в этих секторах"
        }
        
        ### Возможности:
        ${
          riskProfile === "conservative"
            ? "- Стабильный доход: регулярные дивидендные выплаты\n- Защита капитала: низкая волатильность в периоды рыночных спадов"
            : riskProfile === "moderate"
              ? "- Сбалансированный рост: потенциал для долгосрочного роста при умеренном риске\n- Диверсификация: хорошо сбалансированный портфель с различными классами активов"
              : "- Высокий потенциал роста: возможность значительного увеличения капитала\n- Инновационные компании: инвестиции в компании, определяющие будущее технологий и экономики"
        }
        
        ## Заключение
        
        Данный инвестиционный портфель соответствует вашему ${
          riskProfile === "conservative"
            ? "консервативному"
            : riskProfile === "moderate"
              ? "умеренному"
              : "агрессивному"
        } профилю риска и предоставляет ${
          riskProfile === "conservative"
            ? "стабильность и защиту капитала"
            : riskProfile === "moderate"
              ? "баланс между ростом и защитой капитала"
              : "максимальные возможности для роста при соответствующем уровне риска"
        }. Рекомендуется регулярно пересматривать и ребалансировать портфель для поддержания оптимального распределения активов.
      `

      return NextResponse.json({
        success: true,
        report: basicReport,
      })
    }
  } catch (error) {
    console.error("Ошибка при генерации отчета:", error)
    return NextResponse.json(
      {
        success: false,
        error: `Ошибка при генерации отчета: ${error instanceof Error ? error.message : "Неизвестная ошибка"}`,
      },
      { status: 500 },
    )
  }
}

